(()=>{"use strict";var t=function(t){var e=(t=t.toString()).split(/\D/),s=["","0","00","000","0000"].reverse(),i=0;for(let t=0;t<e.length;t++)i=e[t].length,e[t]=s[i]+e[t];return e.join("")};let e={sign:function(t,e){let s=(t+=e).length,i=0;for(;s;)i^=t.charCodeAt(--s);return i<<6},compareVersion:function(e,s){return t(e)>=t(s)},extends:function(){var t,e=arguments[0]||{},s=1,i=arguments.length;for("object"!=typeof e&&(e={});s<i;s++){t=arguments[s];for(let s in t)e[s]=t[s]}return e},randomSort:function(t){return t.sort((function(t,e){return Math.random()>.5?-1:1}))},getRandomArray:function(t,e){let s=[],i=t.length;if(e&&e>=i)return t;let n=[].concat(t),o=0;for(let t=0;t<e;t++)o=Math.floor(Math.random()*n.length),s.push(n[o]),n.splice(o,1);return s},render:function(t,e){return-1===t.indexOf("{{")||-1===t.indexOf("}}")?t:(e=e||{},t.replace(/\{\{([\s\S]+?)\}\}/g,(function(t,s){return e[s]||""})))},gen_uuid:function(){var t=["a","b","c","d","f","g","t","h","i","s","o","y","k","j","e","p","w","v","m","n","x","z"],s=Date.now().toString(),i=(1e5*Math.random()).toString(),n=0,o=[];for(let e=0;e<6;e++)n=Math.floor(1e3*Math.random())%t.length,o.push(t[n]);var a=o.join("")+s.substring(5,s.length)+i.substring(0,2);o=[];for(let t=0,e=a.length;t<e;t++)o.push(a.charAt(t));return(o=e.randomSort(o)).join("")},isWechat:function(){return"object"==typeof wx},isQQ:function(){return"object"==typeof qq},isToutiao:function(){return"object"==typeof tt}};const s=e;let i=[],n=[],o={options:{host:"https://tt.mfofo.com",USER_KEY:"SDK_USER",CONF_KEY:"SDK_CONF",DATA_KEY:"SDK_USER_DATA",TOKEN_KEY:"SDK_TOKEN",UUID_KEY:"SDK_UUID",OPENID_KEY:"SDK_OPEN_ID",PACKAGE_KEY:"SDK_PACKAGE_DATA"},C:{},G:null,confs:{},user:null,data:{},package:null,system:null,launchOptions:null,accountInfo:null,_logs:[],_reports:[],_services:[],_score_data:[],_level_data:[],_grade_data:[],_openid:"",_uuid:"",_getGlobal:function(){return s.isQQ()?qq:s.isToutiao()?tt:s.isWechat()?wx:null},_loadCacheData:function(){this.user=this.G.getStorageSync(this.options.USER_KEY),this.data=this.G.getStorageSync(this.options.DATA_KEY)||{},this._token=this.G.getStorageSync(this.options.TOKEN_KEY),this._uuid=this.G.getStorageSync(this.options.UUID_KEY),this._openid=this.G.getStorageSync(this.options.OPENID_KEY),this.package=this.G.getStorageSync(this.options.PACKAGE_KEY);let t=this.G.getStorageSync(this.options.CONF_KEY);if(t){for(let e of["confs","shares","videos","banners","interstitials","ads","msg_tpls"])this[e]=t[e]||{};for(let e of["server_time","_lastFetchTime"])this[e]=t[e]||0}this._uuid||(this._uuid=s.gen_uuid(),this.G.setStorage({key:o.options.UUID_KEY,data:this._uuid}))},_onShow:function(){for(let t of i)t&&t()},_onHide:function(){for(let t of n)t&&t()},onShow:function(t){"function"==typeof t&&i.push(t)},onHide:function(t){"function"==typeof t&&n.push(t)},init:function(){try{this.C=require("./sdk.config.js")}catch(t){return console.error("sdk.config.js文件不存在, 请到官网后台下载, 并与sdk文件放同一目录."),!1}if(this.G=this._getGlobal(),this.C&&(!this.G&&this.C.global&&"object"==typeof this.C.global&&(this.G=this.C.global),this.C.host&&(this.options.host=this.C.host)),!this.G||"object"!=typeof this.G)return console.error("未检测到平台变量，可以在sdk.config.js指定变量[global]或联系管理员新增平台的支持."),!1;o.util=s,this.G.sdk=o,window&&(window.sdk=o),this._loadCacheData(),this.system=this.G.getSystemInfoSync(),this.launchOptions=this.G.getLaunchOptionsSync(),this.G.getAccountInfoSync&&(this.accountInfo=this.G.getAccountInfoSync()),this.G.onAppShow&&this.G.onAppShow(this._onShow),this.G.onAppHide&&this.G.onAppHide(this._onHide),this.G.onShow&&this.G.onShow(this._onShow),this.G.onHide&&this.G.onHide(this._onHide),this.initShare(),this.C.auto_login&&this.login({})}};const a=o;var r=[];a.extraQuerystring=function(){let t=[];return this.C&&(this.C.app_id&&t.push("appid="+this.C.app_id),this.C.app_version&&t.push("version="+this.C.app_version)),this.user&&this.user.id&&t.push("userid="+this.user.id),this.accountInfo&&this.accountInfo.miniProgram&&this.accountInfo.miniProgram.envVersion&&t.push("env="+this.accountInfo.miniProgram.envVersion),t.join("&")},a.repeatRequest=function(){let t=null;if(!r||0===r.length)return!1;for(;r.length;)t=r.shift(),a.request(t),console.log("repeat request:",t.url)},a.request=function(t){t.method||(t.method="get");let e="";void 0===t.withSign||t.withSign?(e=t.url+(t.url.indexOf("?")>-1?"&":"?")+this.extraQuerystring(),e+="&sign="+s.sign(e,this.C&&this.C.app_key)):e=t.url,t.header||(t.header={}),this._token&&(t.header.token=this._token),0!==e.indexOf("http")&&(e=(t.host?t.host:a.options.host)+e),this.G.request({url:e,method:t.method,data:t.data,header:t.header,success:function(s){if(s&&s.data){if(1006===s.data.status)return r.push(t),a.loginSuccessCallback(a.repeatRequest),a.login({}),!1;if(0===s.data.status)return t.success&&t.success(s.data),!1;console.warn(e,s.data)}t.fail&&t.fail(s.data)},fail:function(e){t.fail&&t.fail(e.data)},complete:function(e){t.complete&&t.complete(e.data)}})},a.get=function(t){if(t.data){let e=[];for(let s in t.data)null!==t.data[s]&&e.push(s+"="+t.data[s]);e.length>0&&(t.url+=(t.url.indexOf("?")>-1?"&":"?")+e.join("&"))}t.method="get",t.data=null,this.request(t)},a.post=function(t){t.method="post",this.request(t)},a.put=function(t){t.method="put",this.request(t)},a.delete=function(t){t.method="delete",this.request(t)},a.upload=function(t){let e="";void 0===t.withSign||t.withSign?(e=t.url+(t.url.indexOf("?")>-1?"&":"?")+this.extraQuerystring(),e+="&sign="+s.sign(e,this.C&&this.C.app_key)):e=t.url,0!==e.indexOf("http")&&(e=(t.host?t.host:a.options.host)+e),t.header||(t.header={}),this._token&&(t.header.token=this._token),t.header["content-type"]="multipart/form-data",t.header.dataType="json",this.G.uploadFile({url:e,filePath:t.filePath,formData:t.data,name:t.name?t.name:"file",header:t.header,success:function(e){if(e&&e.data){if("string"==typeof e.data&&(e.data=JSON.parse(e.data)),1006===e.data.status)return a.login({}),!1;if(0===e.data.status)return t.success&&t.success(e.data),!1}t.fail&&t.fail(e.data)},fail:function(e){t.fail&&t.fail(e.data)},complete:function(e){t.complete&&t.complete(e.data)}})},a.connectSocket=function(t){if(!t.url)return log.warn("'url' can not be null"),!1;let e=t.url+(t.url.indexOf("?")>-1?"&":"?")+this.extraQuerystring();e+="&sign="+s.sign(e,this.C&&this.C.app_key),t.header||(t.header={}),this._token&&(t.header.token=this._token),this.G.connectSocket({url:e,method:t.method,protocols:t.protocols||[],timeout:t.timeout,header:t.header,success:function(e){t.success&&t.success(e)},fail:function(e){t.fail&&t.fail(e)},complete:function(e){t.complete&&t.complete(e)}})},a.getConfig=function({type:t="all",level:e=null,location:s=null,success:i=null,fail:n=null}){this.get({url:"/api/config/",data:{type:t,level:e,location:s},success:function(t){if(!t||!t.data)return i&&i(),!1;let e={};e.confs=a.confs=t.data.config,e.shares=a.shares=t.data.share,e.videos=a.videos=t.data.video,e.banners=a.banners=t.data.banner,e.interstitials=a.interstitials=t.data.interstitial,e.ads=a.ads=t.data.ads,e.msg_tpls=a.msg_tpls=t.data.msg_tpls,e.server_time=a.server_time=t.data.server_time?t.data.server_time:Date.now(),e._lastFetchTime=a._lastFetchTime=Date.now(),a.G.setStorage({key:a.options.CONF_KEY,data:e}),i&&i(t.data)},fail:n})},a.cloudGetConfig=function({success:t=null,fail:e=null}){t&&t()},a.postEvents=function(){this._reports&&this._reports.length>0&&this.post({url:"/logs/app/report/",host:a.C&&a.C.log_host?a.C.log_host:null,data:{data:a._reports},success:function(t){console.log("reports post"),a._reports=[]}})},a.postLogs=function(){if(this.confs&&this.confs.log_disabled)return this._logs=[],console.warn("Logs [log_disabled:true] in configs"),!1;this._logs.push({type:"process",system:a.system?JSON.stringify(a.system):"",launchOptions:a.launchOptions?JSON.stringify(a.launchOptions):"",show:a.startTime?Date.now()-a.startTime:0}),this.post({url:"/logs/app/trace/",host:a.C&&a.C.log_host?a.C.log_host:null,data:{data:a._logs},success:function(t){console.log("log post"),a._logs=[]}})},a.postServices=function(){return this.confs&&this.confs.service_enable?!(!a._services||0===a._services.length)&&void this.post({url:"/logs/app/service/",host:a.C&&a.C.log_host?a.C.log_host:null,data:{data:a._services},success:function(t){console.log("_services post"),a._services=[]}}):(this._services=[],console.warn("Logs [service_enable:false] in configs"),!1)},a.report=function({branchId:t,eventType:e="view",branchDim:s="default"}){return this.confs&&this.confs.report_enable?t?void this._reports.push({branchId:t,eventType:e,branchDim:s}):(console.warn("branchId empty"),!1):(console.log("Report enable is false"),!1)},a.commit=function(){a.postLogs(),a.postData(),a.postEvents()},a.onShow((function(){a.startTime=Date.now()})),a.onHide(a.commit);let l=[],u=[],c=[];function h(t){!a._lastFetchTime||t||Date.now()-a._lastFetchTime>36e4?Promise.all([new Promise(((t,e)=>{a.C.useCloud&&a.C.cloudEnv?a.cloudGetConfig({success:t,fail:e}):a.getConfig({success:t,fail:e})})),new Promise(((t,e)=>{a.C.useCloud&&a.C.cloudEnv?a.cloudGetData(t):a.getData(t)}))]).then(((t,e)=>{d()})):d()}function d(){let t=null;for(;l.length;)t=l.shift(),t&&t();p()}function f(){let t=null;for(;u.length;)t=u.shift(),t&&t()}function p(){let t=null;for(;c.length;)t=c.shift(),t&&t()}function g(t,e){a.C.useCloud&&a.C.cloudEnv||a.post({url:"/api/authorize/",data:{code:t,options:a.getLaunchData(),uuid:a._uuid,openid:e||a._openid||""},success:function(t){a.user=t.data.user,a._token=t.data.token,a.user.last=Date.parse(new Date),a._saveUser(a.user,a._token),h(!0),a.getUserInfo()},fail:function(t){console.warn("login fail:",t),f(),p()}})}a._saveUser=function(t,e){this.G.setStorage({key:a.options.USER_KEY,data:t}),t&&t.openid&&(this.G.setStorage({key:a.options.OPENID_KEY,data:t.openid}),this._openid=t.openid),e&&this.G.setStorage({key:a.options.TOKEN_KEY,data:e})},a.getLaunchData=function(){let t={};if(this.launchOptions){let e=this.launchOptions.query;e.uid&&(t.uid=e.uid),e.share_id&&(t.share_id=e.share_id),e.share_pos&&(t.share_pos=e.share_pos),e.channel&&(t.channel=e.channel),this.launchOptions.referrerInfo&&this.launchOptions.referrerInfo.appId&&(t.referer=this.launchOptions.referrerInfo.appId),this.launchOptions.scene&&(t.scene=this.launchOptions.scene),this.launchOptions.shareTicket&&(t.shareTicket=this.launchOptions.shareTicket)}return t},a.checkLogin=function(){return this._token&&null!=this.user&&this.user.id&&this.user.last&&this.user.last>Date.now()-864e5},a.doLogin=function(t,e){t&&e||this.launchOptions&&"singlePage"===this.launchOptions.mode?g(null,e):this.G.login({success(t){g(t.code,e)},fail(t){console.warn("登录失败:",t),f(),p()}})},a.login=function({success:t=null,fail:e=null,complete:s=null}){try{t&&l.push(t),e&&u.push(e),s&&c.push(s)}catch(t){console.warn(t)}this.G.checkSession({success:function(){return a.checkLogin()?a.user.last&&Date.now()-a.user.last>72e5?(a.doLogin(!0,a.user.openid),!1):void h():(a.doLogin(!0),!1)},fail:function(){a.doLogin(!1)}})},a.reportOpenId=function(t){t&&t.length>5?this.doLogin(!0,t):console.log("Invalid openid: "+t)},a.loginSuccessCallback=function(t){l.push(t)},a.loginFailCallback=function(t){u.push(t)},a.getUserInfo=function(){if(!this.needUserInfo())return!1;this.G.getSetting({success(t){t.authSetting["scope.userInfo"]&&a.G.getUserInfo({success:function(t){let e=t.userInfo;a.user.nickname=e.nickName,a.user.avatar=e.avatarUrl,a.user.gender=e.gender,a.user.province=e.province,a.user.city=e.city,a.user.country=e.country,a._saveUser(a.user),a.updateUserInfo(e)}})}})},a.needUserInfo=function(){return!(this.user&&this.user.nickName&&this.user.avatar)},a.updateUserInfo=function(t){if(!t)return!1;a.post({url:"/api/user/update/",data:t,success:function(t){console.log("userinfo updated")},fail:function(t){console.log("userinfo post fail:",t)}})},a.setData=function(t,e){this.data[t]=e},a.incData=function(t,e){e=e||1,this.data[t]||(this.data[t]=0),this.data[t]+=e},a.addScore=function(t){if(!t||isNaN(t))return console.warn("提交的分数必须为数字"),!1;this._score_data.push(t)},a.addLevel=function(t){if(!t)return console.warn("关卡不能为空"),!1;this._level_data.push(t)},a.addGrade=function(t){if(!t)return console.warn("等级不能为空"),!1;this._grade_data.push(t)},a.postData=function(){if(!this.confs.data_enable)return console.log("Data enable is false, please set [data_enable] config"),!1;let t=this.data;this.G.setStorage({key:this.options.DATA_KEY,data:t}),this.C.useCloud&&this.C.cloudEnv||this.post({url:"/api/data/",data:{data:JSON.stringify(t),score:a._score_data,level:a._level_data,grade:a._grade_data},success:function(t){a.score_data=[],a.level_data=[],a.grade_data=[],console.log("data post")}})},a.uploadPhoto=function({count:t=1,url:e=null,host:s=null,success:i=null,fail:n=null}){if(!this.G.chooseImage)return console.warn("chooseImage is unvailable"),!1;this.G.chooseImage({count:t,sizeType:["original","compressed"],sourceType:["album","camera"],success:t=>{a.upload({files:t.tempFilePaths,url:e||"/api/data/upload/",host:s,success:i,fail:n})},fail:t=>{n&&n(t)}})},a.multipleUpload=function({files:t,upload:e=[],data:s=null,url:i=null,host:n=null,success:o=null,fail:r=null}){if(0===t.length)return e.length>0?o&&o(uploadCount):r&&r(),!1;this.upload({url:i||"/api/data/upload/",host:n,filePath:t.shift(),name:"file",data:s,success(t){e.push(t)},complete(){a.multipleUpload({files:t,upload:e,data:s,success:o,fail:r})}})},a.subscribeMessage=function({pos:t="default",success:e=null,fail:s=null}){let i=this.msg_tpls&&this.msg_tpls[t];return i?this.G.requestSubscribeMessage?void this.G.requestSubscribeMessage({tmplIds:[i],success(t){t[i]&&"accept"===t[i]?(a._services.push({type:"subscribe",status:"accept",tmplId:i}),e&&e()):s&&s()},fail:s}):(console.warn("requestSubscribeMessage is unvailable"),!1):(s&&s({msg:"no subscribe message configs"}),!1)},a.getData=function(t){this.get({url:"/api/data/",data:{},success:function(e){if(!e||!e.data)return t&&t(),!1;a.data&&"{}"!==JSON.stringify(a.data)||(a.data=e.data,a.G.setStorage({key:a.options.DATA_KEY,data:a.data})),t&&t(e.data)},fail:t})},a.cloudGetData=function(t){this.C.useCloud&&this.C.cloudEnv,t&&t()},a.share=function({pos:t="default",title:e=null,image:s=null,path:i="",data:n={}}){let o=this.shareAppMessage({pos:t,title:e,image:s,path:i,data:n});return!!this.G.shareAppMessage&&(this.G.shareAppMessage(o),this._logs.push({type:"share",pos:t,status:"poll"}),!0)},a.shareAppMessage=function({pos:t="default",title:e=null,image:i=null,path:n="",data:o={}}){n||(n="/pages/index/index"),-1===n.indexOf("?")&&(n+="?_=_");let r=a.shares[t],l={};if(r&&r.length>0){let t=s.getRandomArray(r,1)[0]||{};t.id&&(n+="&share_id="+t.id),t.title&&(l.title=s.render(t.title,o)),t.image&&(l.imageUrl=t.image),t.image_id&&a.G.canIUse("shareAppMessage.imageUrlId")&&(l.imageUrlId=t.image_id),t.shareTemplateId&&(l.shareTemplateId=t.shareTemplateId)}return e&&(l.title=s.render(e,o)),i&&(l.imageUrl=i),this.user&&(n+="&uid="+this.user.id),n+="&share_pos="+t,n+="&_tid="+Date.now(),l.path=n,l},a.getShareInfo=function({success:t=null,fail:e=null}){let s=this.launchOptions.shareTicket;if(s)return e&&e(),!1;this.G.getShareInfo({shareTicket:s,success:function(s){a.decryptData({encryptedData:s.encryptedData,iv:s.iv,success:function(e){t&&t(e)},fail:function(t){e&&e(t)}})},fail:function(t){e&&e(t)}})},a.decryptData=function({encryptedData:t,iv:e,success:s=null,fail:i=null}){this.post({url:"/api/data/decrypt",data:{encryptedData:t,iv:e},success:function(t){s&&s(t)},fail:function(t){i&&i(t)}})},a.initShare=function(){if(this.G.onShareAppMessage)try{this.G.onShareAppMessage(this.shareAppMessage({pos:"default"}))}catch(t){console.warn("initShare with onShareAppMessage:",t)}},a.tapAppAd=function({ad:t,success:e=null,fail:s=null}){t.action&&"image"===t.action&&t.image?this.G.previewImage({urls:[t.image],success:function(){a._logs.push({type:"ad",pos:t.pos,status:"preview"}),e&&e()},fail:function(t){s&&s(t)}}):this.G.navigateToMiniProgram?this.G.navigateToMiniProgram({appId:t.appid,path:t.path,success:function(){a._logs.push({type:"ad",pos:t.pos,status:"jump"}),e&&e()},fail:function(t){s&&s(t)}}):s&&s(),this._logs.push({type:"ad",pos:t.pos,status:"click"})},a.createVideo=function({pos:t="default",success:e=null,fail:s=null}){if(!this.videos||!this.videos[t])return s&&s("no video configs"),!1;let i=this.G.createRewardedVideoAd({adUnitId:this.videos[t].ad_unitid});i.onError((function(e){s&&s(e),i.offClose(),i.offLoad(),a._logs.push({type:"video",pos:t,status:"error"})})),i.onClose((function(t){t&&t.isEnded?e&&e(!0):e&&e(!1)})),i.load().then((()=>{i.show(),a._logs.push({type:"video",pos:t,status:"show"})}))},a.createInterstitial=function({pos:t="default",success:e=null,fail:s=null}){if(!this.interstitials||!this.interstitials[t])return s&&s("no video configs"),!1;if(!this.G.createInterstitialAd)return s&&s("sdk not support createInterstitialAd"),!1;let i=this.G.createInterstitialAd({adUnitId:this.interstitials[t].ad_unitid});i.onError((function(e){s&&s(e),i.offClose(),i.offLoad(),a._logs.push({type:"interstitial",pos:t,status:"error"})})),i.onClose((function(){e&&e(!0)})),i.load().then((()=>{i.show(),a._logs.push({type:"interstitial",pos:t,status:"show"})}))},a.init()})();